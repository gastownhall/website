---
import DocsLayout from '../../../layouts/DocsLayout.astro';

const content = "<p>\n> Design document for the Gas Town plugin system.\n> Written 2026-01-11, crew/george session.\n</p>\n<h2>Problem Statement</h2>\n<p>\nGas Town needs extensible, project-specific automation that runs during Deacon patrol cycles. The immediate use case is rebuilding stale binaries (gt, bd, wv), but the pattern generalizes to any periodic maintenance task.\n</p>\n<p>\nCurrent state:\n</p>\n<ul><li>Plugin infrastructure exists conceptually (patrol step mentions it)</li>\n<li><code>~/gt/plugins/</code> directory exists with README</li>\n<li>No actual plugins in production use</li>\n<li>No formalized execution model</li>\n</ul>\n<h2>Design Principles Applied</h2>\n<h3>Discover, Don't Track</h3>\n<p>\n> Reality is truth. State is derived.\n</p>\n<p>\nPlugin state (last run, run count, results) lives on the ledger as wisps, not in shadow state files. Gate evaluation queries the ledger directly.\n</p>\n<h3>ZFC: Zero Framework Cognition</h3>\n<p>\n> Agent decides. Go transports.\n</p>\n<p>\nThe Deacon (agent) evaluates gates and decides whether to dispatch. Go code provides transport (<code>gt dog dispatch</code>) but doesn't make decisions.\n</p>\n<h3>MEOW Stack Integration</h3>\n<table><tr><td>Layer</td><td>Plugin Analog</td></tr>\n</table>\n<table><tr><td><strong>M</strong>olecule</td><td><code>plugin.md</code> - work template with TOML frontmatter</td></tr>\n<tr><td><strong>E</strong>phemeral</td><td>Plugin-run wisps - high-volume, digestible</td></tr>\n<tr><td><strong>O</strong>bservable</td><td>Plugin runs appear in <code>bd activity</code> feed</td></tr>\n<tr><td><strong>W</strong>orkflow</td><td>Gate → Dispatch → Execute → Record → Digest</td></tr>\n</table>\n<p>\n---\n</p>\n<h2>Architecture</h2>\n<h3>Plugin Locations</h3>\n<p>\n<pre><code class=\"language-text\">~/gt/\n├── plugins/                      # Town-level plugins (universal)\n│   └── README.md\n├── gastown/\n│   └── plugins/                  # Rig-level plugins\n│       └── rebuild-gt/\n│           └── plugin.md\n├── beads/\n│   └── plugins/\n│       └── rebuild-bd/\n│           └── plugin.md\n└── wyvern/\n    └── plugins/\n        └── rebuild-wv/\n            └── plugin.md</code></pre>\n</p>\n<strong>Town-level</strong> (<code>~/gt/plugins/</code>): Universal plugins that apply everywhere.\n<strong>Rig-level</strong> (<code>&lt;rig&gt;/plugins/</code>): Project-specific plugins.\n<p>\nThe Deacon scans both locations during patrol.\n</p>\n<h3>Execution Model: Dog Dispatch</h3>\n<strong>Key insight</strong>: Plugin execution should not block Deacon patrol.\n<p>\nDogs are reusable workers designed for infrastructure tasks. Plugin execution is dispatched to dogs:\n</p>\n<p>\n<pre><code class=\"language-text\">Deacon Patrol                    Dog Worker\n─────────────────               ─────────────────\n1. Scan plugins\n2. Evaluate gates\n3. For open gates:\n   └─ gt dog dispatch plugin     ──→ 4. Execute plugin\n      (non-blocking)                  5. Create result wisp\n                                      6. Send DOG_DONE\n4. Continue patrol\n   ...\n5. Process DOG_DONE              ←── (next cycle)</code></pre>\n</p>\n<p>\nBenefits:\n</p>\n<ul><li>Deacon stays responsive</li>\n<li>Multiple plugins can run concurrently (different dogs)</li>\n<li>Plugin failures don't stall patrol</li>\n<li>Consistent with Dogs' purpose (infrastructure work)</li>\n</ul>\n<h3>State Tracking: Wisps on the Ledger</h3>\n<p>\nEach plugin run creates a wisp:\n</p>\n<p>\n<pre><code class=\"language-bash\">bd wisp create \\\n  --label type:plugin-run \\\n  --label plugin:rebuild-gt \\\n  --label rig:gastown \\\n  --label result:success \\\n  --body &quot;Rebuilt gt: abc123 → def456 (5 commits)&quot;</code></pre>\n</p>\n<strong>Gate evaluation</strong> queries wisps instead of state files:\n<p>\n<pre><code class=\"language-bash\"># Cooldown check: any runs in last hour?\nbd list --type=wisp --label=plugin:rebuild-gt --since=1h --limit=1</code></pre>\n</p>\n<strong>Derived state</strong> (no state.json needed):\n<table><tr><td>Query</td><td>Command</td></tr>\n</table>\n<table><tr><td>Last run time</td><td><code>bd list --label=plugin:X --limit=1 --json</code></td></tr>\n<tr><td>Run count</td><td><code>bd list --label=plugin:X --json \\| jq length</code></td></tr>\n<tr><td>Last result</td><td>Parse <code>result:</code> label from latest wisp</td></tr>\n<tr><td>Failure rate</td><td>Count <code>result:failure</code> vs total</td></tr>\n</table>\n<h3>Digest Pattern</h3>\n<p>\nLike cost digests, plugin wisps accumulate and get squashed daily:\n</p>\n<p>\n<pre><code class=\"language-bash\">gt plugin digest --yesterday</code></pre>\n</p>\n<p>\nCreates: <code>Plugin Digest 2026-01-10</code> bead with summary\nDeletes: Individual plugin-run wisps from that day\n</p>\n<p>\nThis keeps the ledger clean while preserving audit history.\n</p>\n<p>\n---\n</p>\n<h2>Plugin Format Specification</h2>\n<h3>File Structure</h3>\n<p>\n<pre><code class=\"language-text\">rebuild-gt/\n└── plugin.md      # Definition with TOML frontmatter</code></pre>\n</p>\n<h3>plugin.md Format</h3>\n<p>\n<pre><code class=\"language-markdown\">+++\nname = &quot;rebuild-gt&quot;\ndescription = &quot;Rebuild stale gt binary from source&quot;\nversion = 1\n\n[gate]\ntype = &quot;cooldown&quot;\nduration = &quot;1h&quot;\n\n[tracking]\nlabels = [&quot;plugin:rebuild-gt&quot;, &quot;rig:gastown&quot;, &quot;category:maintenance&quot;]\ndigest = true\n\n[execution]\ntimeout = &quot;5m&quot;\nnotify_on_failure = true\n+++\n\n# Rebuild gt Binary\n\nInstructions for the dog worker to execute...</code></pre>\n</p>\n<h3>TOML Frontmatter Schema</h3>\n<p>\n<pre><code class=\"language-toml\"># Required\nname = &quot;string&quot;           # Unique plugin identifier\ndescription = &quot;string&quot;    # Human-readable description\nversion = 1               # Schema version (for future evolution)\n\n[gate]\ntype = &quot;cooldown|cron|condition|event|manual&quot;\n# Type-specific fields:\nduration = &quot;1h&quot;           # For cooldown\nschedule = &quot;0 9 * * *&quot;    # For cron\ncheck = &quot;gt stale -q&quot;     # For condition (exit 0 = run)\non = &quot;startup&quot;            # For event\n\n[tracking]\nlabels = [&quot;label:value&quot;, ...]  # Labels for execution wisps\ndigest = true|false            # Include in daily digest\n\n[execution]\ntimeout = &quot;5m&quot;            # Max execution time\nnotify_on_failure = true  # Escalate on failure\nseverity = &quot;low&quot;          # Escalation severity if failed</code></pre>\n</p>\n<h3>Gate Types</h3>\n<table><tr><td>Type</td><td>Config</td><td>Behavior</td></tr>\n</table>\n<table><tr><td><code>cooldown</code></td><td><code>duration = &quot;1h&quot;</code></td><td>Query wisps, run if none in window</td></tr>\n<tr><td><code>cron</code></td><td><code>schedule = &quot;0 9 * * *&quot;</code></td><td>Run on cron schedule</td></tr>\n<tr><td><code>condition</code></td><td><code>check = &quot;cmd&quot;</code></td><td>Run check command, run if exit 0</td></tr>\n<tr><td><code>event</code></td><td><code>on = &quot;startup&quot;</code></td><td>Run on Deacon startup</td></tr>\n<tr><td><code>manual</code></td><td>(no gate section)</td><td>Never auto-run, dispatch explicitly</td></tr>\n</table>\n<h3>Instructions Section</h3>\n<p>\nThe markdown body after the frontmatter contains agent-executable instructions. The dog worker reads and executes these steps.\n</p>\n<p>\nStandard sections:\n</p>\n<ul><li><strong>Detection</strong>: Check if action is needed</li>\n<li><strong>Action</strong>: The actual work</li>\n<li><strong>Record Result</strong>: Create the execution wisp</li>\n<li><strong>Notification</strong>: On success/failure</li>\n</ul>\n<p>\n---\n</p>\n<h2>Escalation System</h2>\n<h3>Problem</h3>\n<p>\nCurrent escalation is ad-hoc \"mail Mayor\". Issues:\n</p>\n<ul><li>Mayor gets backlogged easily</li>\n<li>No severity differentiation</li>\n<li>No alternative channels (email, SMS, etc.)</li>\n<li>No tracking of stale escalations</li>\n</ul>\n<h3>Solution: Unified Escalation API</h3>\n<p>\nNew command:\n</p>\n<p>\n<pre><code class=\"language-bash\">gt escalate \\\n  --severity=&lt;low|medium|high|critical&gt; \\\n  --subject=&quot;Plugin FAILED: rebuild-gt&quot; \\\n  --body=&quot;Build failed: make returned exit code 2&quot; \\\n  --source=&quot;plugin:rebuild-gt&quot;</code></pre>\n</p>\n<h3>Escalation Routing</h3>\n<p>\nThe command reads town config (<code>~/gt/config.json</code> or similar) for routing rules:\n</p>\n<p>\n<pre><code class=\"language-json\">{\n  &quot;escalation&quot;: {\n    &quot;routes&quot;: {\n      &quot;low&quot;: [&quot;bead&quot;],\n      &quot;medium&quot;: [&quot;bead&quot;, &quot;mail:mayor&quot;],\n      &quot;high&quot;: [&quot;bead&quot;, &quot;mail:mayor&quot;, &quot;email:human&quot;],\n      &quot;critical&quot;: [&quot;bead&quot;, &quot;mail:mayor&quot;, &quot;email:human&quot;, &quot;sms:human&quot;]\n    },\n    &quot;contacts&quot;: {\n      &quot;human_email&quot;: &quot;steve@example.com&quot;,\n      &quot;human_sms&quot;: &quot;+1234567890&quot;\n    },\n    &quot;stale_threshold&quot;: &quot;4h&quot;\n  }\n}</code></pre>\n</p>\n<h3>Escalation Actions</h3>\n<table><tr><td>Action</td><td>Behavior</td></tr>\n</table>\n<table><tr><td><code>bead</code></td><td>Create escalation bead with severity label</td></tr>\n<tr><td><code>mail:mayor</code></td><td>Send mail to mayor/</td></tr>\n<tr><td><code>email:human</code></td><td>Send email via configured service</td></tr>\n<tr><td><code>sms:human</code></td><td>Send SMS via configured service</td></tr>\n</table>\n<h3>Escalation Beads</h3>\n<p>\nEvery escalation creates a bead:\n</p>\n<p>\n<pre><code class=\"language-yaml\">type: escalation\nstatus: open\nlabels:\n  - severity:high\n  - source:plugin:rebuild-gt\n  - acknowledged:false</code></pre>\n</p>\n<h3>Stale Escalation Patrol</h3>\n<p>\nA patrol step (or plugin!) checks for unacknowledged escalations:\n</p>\n<p>\n<pre><code class=\"language-bash\">bd list --type=escalation --label=acknowledged:false --older-than=4h</code></pre>\n</p>\n<p>\nStale escalations get re-escalated at higher severity.\n</p>\n<h3>Acknowledging Escalations</h3>\n<p>\n<pre><code class=\"language-bash\">gt escalate ack &lt;bead-id&gt;\n# Sets label acknowledged:true</code></pre>\n</p>\n<p>\n---\n</p>\n<h2>New Commands Required</h2>\n<h3>gt stale</h3>\n<p>\nExpose binary staleness check:\n</p>\n<p>\n<pre><code class=\"language-bash\">gt stale              # Human-readable output\ngt stale --json       # Machine-readable\ngt stale --quiet      # Exit code only (0=stale, 1=fresh)</code></pre>\n</p>\n<h3>gt dog dispatch</h3>\n<p>\nFormalized plugin dispatch to dogs:\n</p>\n<p>\n<pre><code class=\"language-bash\">gt dog dispatch --plugin &lt;name&gt; [--rig &lt;rig&gt;]</code></pre>\n</p>\n<p>\nThis:\n</p>\n<ol><li>Finds the plugin definition</li>\n<li>Slinga a standardized work unit to an idle dog</li>\n<li>Returns immediately (non-blocking)</li>\n</ol>\n<h3>gt escalate</h3>\n<p>\nUnified escalation API:\n</p>\n<p>\n<pre><code class=\"language-bash\">gt escalate \\\n  --severity=&lt;level&gt; \\\n  --subject=&quot;...&quot; \\\n  --body=&quot;...&quot; \\\n  [--source=&quot;...&quot;]\n\ngt escalate ack &lt;bead-id&gt;\ngt escalate list [--severity=...] [--stale]</code></pre>\n</p>\n<h3>gt plugin</h3>\n<p>\nPlugin management:\n</p>\n<p>\n<pre><code class=\"language-bash\">gt plugin list                    # List all plugins\ngt plugin show &lt;name&gt;             # Show plugin details\ngt plugin run &lt;name&gt; [--force]    # Manual trigger\ngt plugin digest [--yesterday]    # Squash wisps to digest\ngt plugin history &lt;name&gt;          # Show execution history</code></pre>\n</p>\n<p>\n---\n</p>\n<h2>Implementation Plan</h2>\n<h3>Phase 1: Foundation</h3>\n<ol><li><strong><code>gt stale</code> command</strong> - Expose CheckStaleBinary() via CLI</li>\n<li><strong>Plugin format spec</strong> - Finalize TOML schema</li>\n<li><strong>Plugin scanning</strong> - Deacon scans town + rig plugin dirs</li>\n</ol>\n<h3>Phase 2: Execution</h3>\n<ol><li><strong><code>gt dog dispatch --plugin</code></strong> - Formalized dog dispatch</li>\n<li><strong>Plugin execution in dogs</strong> - Dog reads plugin.md, executes</li>\n<li><strong>Wisp creation</strong> - Record results on ledger</li>\n</ol>\n<h3>Phase 3: Gates & State</h3>\n<ol><li><strong>Gate evaluation</strong> - Cooldown via wisp query</li>\n<li><strong>Other gate types</strong> - Cron, condition, event</li>\n<li><strong>Plugin digest</strong> - Daily squash of plugin wisps</li>\n</ol>\n<h3>Phase 4: Escalation</h3>\n<ol><li><strong><code>gt escalate</code> command</strong> - Unified escalation API</li>\n<li><strong>Escalation routing</strong> - Config-driven multi-channel</li>\n<li><strong>Stale escalation patrol</strong> - Check unacknowledged</li>\n</ol>\n<h3>Phase 5: First Plugin</h3>\n<ol><li><strong><code>rebuild-gt</code> plugin</strong> - The actual gastown plugin</li>\n<li><strong>Documentation</strong> - So Beads/Wyvern can create theirs</li>\n</ol>\n<p>\n---\n</p>\n<h2>Example: rebuild-gt Plugin</h2>\n<p>\n<pre><code class=\"language-markdown\">+++\nname = &quot;rebuild-gt&quot;\ndescription = &quot;Rebuild stale gt binary from gastown source&quot;\nversion = 1\n\n[gate]\ntype = &quot;cooldown&quot;\nduration = &quot;1h&quot;\n\n[tracking]\nlabels = [&quot;plugin:rebuild-gt&quot;, &quot;rig:gastown&quot;, &quot;category:maintenance&quot;]\ndigest = true\n\n[execution]\ntimeout = &quot;5m&quot;\nnotify_on_failure = true\nseverity = &quot;medium&quot;\n+++\n\n# Rebuild gt Binary\n\nChecks if the gt binary is stale (built from older commit than HEAD) and rebuilds.\n\n## Gate Check\n\nThe Deacon evaluates this before dispatch. If gate closed, skip.\n\n## Detection\n\nCheck binary staleness:</code></pre>bash\ngt stale --json\n<pre><code class=\"language-text\">If `&quot;stale&quot;: false`, record success wisp and exit early.\n\n## Action\n\nRebuild from source:</code></pre>bash\ncd ~/gt/gastown/crew/george && make build && make install\n<pre><code class=\"language-text\">## Record Result\n\nOn success:</code></pre>bash\nbd wisp create \\\n  --label type:plugin-run \\\n  --label plugin:rebuild-gt \\\n  --label rig:gastown \\\n  --label result:success \\\n  --body \"Rebuilt gt: $OLD → $NEW ($N commits)\"\n<pre><code class=\"language-text\">On failure:</code></pre>bash\nbd wisp create \\\n  --label type:plugin-run \\\n  --label plugin:rebuild-gt \\\n  --label rig:gastown \\\n  --label result:failure \\\n  --body \"Build failed: $ERROR\"\n</p>\n<p>\ngt escalate --severity=medium \\\n  --subject=\"Plugin FAILED: rebuild-gt\" \\\n  --body=\"$ERROR\" \\\n  --source=\"plugin:rebuild-gt\"\n<pre><code class=\"language-text\"></code></pre>\n</p>\n<p>\n---\n</p>\n<h2>Open Questions</h2>\n<ol><li><strong>Plugin discovery in multiple clones</strong>: If gastown has crew/george, crew/max, crew/joe - which clone's plugins/ dir is canonical? Probably: scan all, dedupe by name, prefer rig-root if exists.</li>\n</ol>\n<ol><li><strong>Dog assignment</strong>: Should specific plugins prefer specific dogs? Or any idle dog?</li>\n</ol>\n<ol><li><strong>Plugin dependencies</strong>: Can plugins depend on other plugins? Probably not in v1.</li>\n</ol>\n<ol><li><strong>Plugin disable/enable</strong>: How to temporarily disable a plugin without deleting it? Label on a plugin bead? <code>enabled = false</code> in frontmatter?</li>\n</ol>\n<p>\n---\n</p>\n<h2>References</h2>\n<ul><li>PRIMING.md - Core design principles</li>\n<li>mol-deacon-patrol.formula.toml - Patrol step plugin-run</li>\n<li>~/gt/plugins/README.md - Current plugin stub</li></ul>";
---

<DocsLayout title="Plugin System Design" description="> Design document for the Gas Town plugin system. > Written 2026-01-11, crew/george session.">
  <div class="markdown-content" set:html={content} />
</DocsLayout>
