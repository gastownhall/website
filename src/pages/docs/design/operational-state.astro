---
import DocsLayout from '../../../layouts/DocsLayout.astro';

const content = "<p>\n> Managing runtime state through events and labels.\n</p>\n<h2>Overview</h2>\n<p>\nGas Town tracks operational state changes as structured data. This document covers:\n</p>\n<ul><li><strong>Events</strong>: State transitions as beads (immutable audit trail)</li>\n<li><strong>Labels-as-state</strong>: Fast queries via role bead labels (current state cache)</li>\n</ul>\n<p>\nFor Boot triage and degraded mode details, see <a href=\"watchdog-chain.md\">Watchdog Chain</a>.\n</p>\n<h2>Events: State Transitions as Data</h2>\n<p>\nOperational state changes are recorded as event beads. Each event captures:\n</p>\n<ul><li><strong>What</strong> changed (<code>event_type</code>)</li>\n<li><strong>Who</strong> caused it (<code>actor</code>)</li>\n<li><strong>What</strong> was affected (<code>target</code>)</li>\n<li><strong>Context</strong> (<code>payload</code>)</li>\n<li><strong>When</strong> (<code>created_at</code>)</li>\n</ul>\n<h3>Event Types</h3>\n<table><tr><td>Event Type</td><td>Description</td><td>Payload</td></tr>\n</table>\n<table><tr><td><code>patrol.muted</code></td><td>Patrol cycle disabled</td><td><code>{reason, until?}</code></td></tr>\n<tr><td><code>patrol.unmuted</code></td><td>Patrol cycle re-enabled</td><td><code>{reason?}</code></td></tr>\n<tr><td><code>agent.started</code></td><td>Agent session began</td><td><code>{session_id?}</code></td></tr>\n<tr><td><code>agent.stopped</code></td><td>Agent session ended</td><td><code>{reason, outcome?}</code></td></tr>\n<tr><td><code>mode.degraded</code></td><td>System entered degraded mode</td><td><code>{reason}</code></td></tr>\n<tr><td><code>mode.normal</code></td><td>System returned to normal</td><td><code>{}</code></td></tr>\n</table>\n<h3>Creating Events</h3>\n<pre><code class=\"language-bash\"># Mute deacon patrol\n<p>\nbd create --type=event --event-type=patrol.muted \\\n  --actor=human:overseer --target=agent:deacon \\\n  --payload='{&quot;reason&quot;:&quot;fixing convoy deadlock&quot;,&quot;until&quot;:&quot;gt-abc1&quot;}'\n</p>\n<h1>System entered degraded mode</h1>\n<p>\nbd create --type=event --event-type=mode.degraded \\\n  --actor=system:daemon --target=rig:greenplace \\\n  --payload='{&quot;reason&quot;:&quot;tmux unavailable&quot;}'</code></pre>\n</p>\n<h3>Querying Events</h3>\n<pre><code class=\"language-bash\"># Recent events for an agent\n<p>\nbd list --type=event --target=agent:deacon --limit=10\n</p>\n<h1>All patrol state changes</h1>\n<p>\nbd list --type=event --event-type=patrol.muted\nbd list --type=event --event-type=patrol.unmuted\n</p>\n<h1>Events in the activity feed</h1>\n<p>\nbd activity --follow --type=event</code></pre>\n</p>\n<h2>Labels-as-State Pattern</h2>\n<p>\nEvents capture the full history. Labels cache the current state for fast queries.\n</p>\n<h3>Convention</h3>\n<p>\nLabels use <code><dimension>:<value></code> format:\n</p>\n<ul><li><code>patrol:muted</code> / <code>patrol:active</code></li>\n<li><code>mode:degraded</code> / <code>mode:normal</code></li>\n<li><code>status:idle</code> / <code>status:working</code> (for persistent agents only - see note)</li>\n</ul>\n<strong>Note on polecats:</strong> The <code>status:idle</code> label does NOT apply to polecats. Polecats\n<p>\nhave no idle state - they're either working, stalled (stopped unexpectedly), or\nzombie (<code>gt done</code> failed). This label is for persistent agents like Deacon, Witness,\nand Crew members who can legitimately be idle between tasks.\n</p>\n<h3>State Change Flow</h3>\n<p>\n1. Create event bead (full context, immutable)\n2. Update role bead labels (current state cache)\n</p>\n<pre><code class=\"language-bash\"># Mute patrol\n<p>\nbd create --type=event --event-type=patrol.muted ...\nbd update role-deacon --add-label=patrol:muted --remove-label=patrol:active\n</p>\n<h1>Unmute patrol</h1>\n<p>\nbd create --type=event --event-type=patrol.unmuted ...\nbd update role-deacon --add-label=patrol:active --remove-label=patrol:muted</code></pre>\n</p>\n<h3>Querying Current State</h3>\n<pre><code class=\"language-bash\"># Is deacon patrol muted?\n<p>\nbd show role-deacon | grep patrol:\n</p>\n<h1>All agents with muted patrol</h1>\n<p>\nbd list --type=role --label=patrol:muted\n</p>\n<h1>All agents in degraded mode</h1>\n<p>\nbd list --type=role --label=mode:degraded</code></pre>\n</p>\n<h2>Configuration vs State</h2>\n<table><tr><td>Type</td><td>Storage</td><td>Example</td></tr>\n</table>\n<table><tr><td><strong>Static config</strong></td><td>TOML files</td><td>Daemon tick interval</td></tr>\n<tr><td><strong>Operational state</strong></td><td>Beads (events + labels)</td><td>Patrol muted</td></tr>\n<tr><td><strong>Runtime flags</strong></td><td>Marker files</td><td><code>.deacon-disabled</code></td></tr>\n</table>\n<p>\nStatic config rarely changes and doesn't need history.\nOperational state changes at runtime and benefits from audit trail.\nMarker files are fast checks that can trigger deeper beads queries.\n</p>\n<h2>Commands Summary</h2>\n<pre><code class=\"language-bash\"># Create operational event\n<p>\nbd create --type=event --event-type=&lt;type&gt; \\\n  --actor=&lt;entity&gt; --target=&lt;entity&gt; --payload='&lt;json&gt;'\n</p>\n<h1>Update state label</h1>\n<p>\nbd update &lt;role-bead&gt; --add-label=&lt;dim&gt;:&lt;val&gt; --remove-label=&lt;dim&gt;:&lt;old&gt;\n</p>\n<h1>Query current state</h1>\n<p>\nbd list --type=role --label=&lt;dim&gt;:&lt;val&gt;\n</p>\n<h1>Query state history</h1>\n<p>\nbd list --type=event --target=&lt;entity&gt;\n</p>\n<h1>Boot management</h1>\n<p>\ngt dog status boot\ngt dog call boot\ngt dog prime boot</code></pre>\n</p>\n<p>\n---\n</p>\n<em>Events are the source of truth. Labels are the cache.</em>";
---

<DocsLayout title="Operational State in Gas Town" description="> Managing runtime state through events and labels.">
  <div class="markdown-content" set:html={content} />
</DocsLayout>
