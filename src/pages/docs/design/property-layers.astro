---
import DocsLayout from '../../../layouts/DocsLayout.astro';

const content = "<p>\n> Implementation guide for Gas Town's configuration system.\n> Created: 2025-01-06\n</p>\n<h2>Overview</h2>\n<p>\nGas Town uses a layered property system for configuration. Properties are\nlooked up through multiple layers, with earlier layers overriding later ones.\nThis enables both local control and global coordination.\n</p>\n<h2>The Four Layers</h2>\n<p>\n<pre><code class=\"language-text\">┌─────────────────────────────────────────────────────────────┐\n│ 1. WISP LAYER (transient, town-local)                       │\n│    Location: &lt;rig&gt;/.beads-wisp/config/                      │\n│    Synced: Never                                            │\n│    Use: Temporary local overrides                           │\n└─────────────────────────────┬───────────────────────────────┘\n                              │ if missing\n                              ▼\n┌─────────────────────────────────────────────────────────────┐\n│ 2. RIG BEAD LAYER (persistent, synced globally)             │\n│    Location: &lt;rig&gt;/.beads/ (rig identity bead labels)       │\n│    Synced: Via git (all clones see it)                      │\n│    Use: Project-wide operational state                      │\n└─────────────────────────────┬───────────────────────────────┘\n                              │ if missing\n                              ▼\n┌─────────────────────────────────────────────────────────────┐\n│ 3. TOWN DEFAULTS                                            │\n│    Location: ~/gt/config.json or ~/gt/.beads/               │\n│    Synced: N/A (per-town)                                   │\n│    Use: Town-wide policies                                  │\n└─────────────────────────────┬───────────────────────────────┘\n                              │ if missing\n                              ▼\n┌─────────────────────────────────────────────────────────────┐\n│ 4. SYSTEM DEFAULTS (compiled in)                            │\n│    Use: Fallback when nothing else specified                │\n└─────────────────────────────────────────────────────────────┘</code></pre>\n</p>\n<h2>Lookup Behavior</h2>\n<h3>Override Semantics (Default)</h3>\n<p>\nFor most properties, the first non-nil value wins:\n</p>\n<p>\n<pre><code class=\"language-go\">func GetConfig(key string) interface{} {\n    if val := wisp.Get(key); val != nil {\n        if val == Blocked { return nil }\n        return val\n    }\n    if val := rigBead.GetLabel(key); val != nil {\n        return val\n    }\n    if val := townDefaults.Get(key); val != nil {\n        return val\n    }\n    return systemDefaults[key]\n}</code></pre>\n</p>\n<h3>Stacking Semantics (Integers)</h3>\n<p>\nFor integer properties, values from wisp and bead layers <strong>add</strong> to the base:\n</p>\n<p>\n<pre><code class=\"language-go\">func GetIntConfig(key string) int {\n    base := getBaseDefault(key)    // Town or system default\n    beadAdj := rigBead.GetInt(key) // 0 if missing\n    wispAdj := wisp.GetInt(key)    // 0 if missing\n    return base + beadAdj + wispAdj\n}</code></pre>\n</p>\n<p>\nThis enables temporary adjustments without changing the base value.\n</p>\n<h3>Blocking Inheritance</h3>\n<p>\nYou can explicitly block a property from being inherited:\n</p>\n<p>\n<pre><code class=\"language-bash\">gt rig config set gastown auto_restart --block</code></pre>\n</p>\n<p>\nThis creates a \"blocked\" marker in the wisp layer. Even if the rig bead\nor defaults say <code>auto_restart: true</code>, the lookup returns nil.\n</p>\n<h2>Rig Identity Beads</h2>\n<p>\nEach rig has an identity bead for operational state:\n</p>\n<p>\n<pre><code class=\"language-yaml\">id: gt-rig-gastown\ntype: rig\nname: gastown\nrepo: git@github.com:steveyegge/gastown.git\nprefix: gt\n\nlabels:\n  - status:operational\n  - priority:normal</code></pre>\n</p>\n<p>\nThese beads sync via git, so all clones of the rig see the same state.\n</p>\n<h2>Two-Level Rig Control</h2>\n<h3>Level 1: Park (Local, Ephemeral)</h3>\n<p>\n<pre><code class=\"language-bash\">gt rig park gastown      # Stop services, daemon won't restart\ngt rig unpark gastown    # Allow services to run</code></pre>\n</p>\n<ul><li>Stored in wisp layer (<code>.beads-wisp/config/</code>)</li>\n<li>Only affects this town</li>\n<li>Disappears on cleanup</li>\n<li>Use: Local maintenance, debugging</li>\n</ul>\n<h3>Level 2: Dock (Global, Persistent)</h3>\n<p>\n<pre><code class=\"language-bash\">gt rig dock gastown      # Set status:docked label on rig bead\ngt rig undock gastown    # Remove label</code></pre>\n</p>\n<ul><li>Stored on rig identity bead</li>\n<li>Syncs to all clones via git</li>\n<li>Permanent until explicitly changed</li>\n<li>Use: Project-wide maintenance, coordinated downtime</li>\n</ul>\n<h3>Daemon Behavior</h3>\n<p>\nThe daemon checks both levels before auto-restarting:\n</p>\n<p>\n<pre><code class=\"language-go\">func shouldAutoRestart(rig *Rig) bool {\n    status := rig.GetConfig(&quot;status&quot;)\n    if status == &quot;parked&quot; || status == &quot;docked&quot; {\n        return false\n    }\n    return true\n}</code></pre>\n</p>\n<h2>Configuration Keys</h2>\n<table><tr><td>Key</td><td>Type</td><td>Behavior</td><td>Description</td></tr>\n</table>\n<table><tr><td><code>status</code></td><td>string</td><td>Override</td><td>operational/parked/docked</td></tr>\n<tr><td><code>auto_restart</code></td><td>bool</td><td>Override</td><td>Daemon auto-restart behavior</td></tr>\n<tr><td><code>max_polecats</code></td><td>int</td><td>Override</td><td>Maximum concurrent polecats</td></tr>\n<tr><td><code>priority_adjustment</code></td><td>int</td><td><strong>Stack</strong></td><td>Scheduling priority modifier</td></tr>\n<tr><td><code>maintenance_window</code></td><td>string</td><td>Override</td><td>When maintenance allowed</td></tr>\n<tr><td><code>dnd</code></td><td>bool</td><td>Override</td><td>Do not disturb mode</td></tr>\n</table>\n<h2>Commands</h2>\n<h3>View Configuration</h3>\n<p>\n<pre><code class=\"language-bash\">gt rig config show gastown           # Show effective config (all layers)\ngt rig config show gastown --layer   # Show which layer each value comes from</code></pre>\n</p>\n<h3>Set Configuration</h3>\n<p>\n<pre><code class=\"language-bash\"># Set in wisp layer (local, ephemeral)\ngt rig config set gastown key value\n\n# Set in bead layer (global, permanent)\ngt rig config set gastown key value --global\n\n# Block inheritance\ngt rig config set gastown key --block\n\n# Clear from wisp layer\ngt rig config unset gastown key</code></pre>\n</p>\n<h3>Rig Lifecycle</h3>\n<p>\n<pre><code class=\"language-bash\">gt rig park gastown          # Local: stop + prevent restart\ngt rig unpark gastown        # Local: allow restart\n\ngt rig dock gastown          # Global: mark as offline\ngt rig undock gastown        # Global: mark as operational\n\ngt rig status gastown        # Show current state</code></pre>\n</p>\n<h2>Examples</h2>\n<h3>Temporary Priority Boost</h3>\n<p>\n<pre><code class=\"language-bash\"># Base priority: 0 (from defaults)\n# Give this rig temporary priority boost for urgent work\n\ngt rig config set gastown priority_adjustment 10\n\n# Effective priority: 0 + 10 = 10\n# When done, clear it:\n\ngt rig config unset gastown priority_adjustment</code></pre>\n</p>\n<h3>Local Maintenance</h3>\n<p>\n<pre><code class=\"language-bash\"># I'm upgrading the local clone, don't restart services\ngt rig park gastown\n\n# ... do maintenance ...\n\ngt rig unpark gastown</code></pre>\n</p>\n<h3>Project-Wide Maintenance</h3>\n<p>\n<pre><code class=\"language-bash\"># Major refactor in progress, all clones should pause\ngt rig dock gastown\n\n# Syncs via git - other towns see the rig as docked\nbd sync\n\n# When done:\ngt rig undock gastown\nbd sync</code></pre>\n</p>\n<h3>Block Auto-Restart Locally</h3>\n<p>\n<pre><code class=\"language-bash\"># Rig bead says auto_restart: true\n# But I'm debugging and don't want that here\n\ngt rig config set gastown auto_restart --block\n\n# Now auto_restart returns nil for this town only</code></pre>\n</p>\n<h2>Implementation Notes</h2>\n<h3>Wisp Storage</h3>\n<p>\nWisp config stored in <code>.beads-wisp/config/&lt;rig&gt;.json</code>:\n</p>\n<p>\n<pre><code class=\"language-json\">{\n  &quot;rig&quot;: &quot;gastown&quot;,\n  &quot;values&quot;: {\n    &quot;status&quot;: &quot;parked&quot;,\n    &quot;priority_adjustment&quot;: 10\n  },\n  &quot;blocked&quot;: [&quot;auto_restart&quot;]\n}</code></pre>\n</p>\n<h3>Rig Bead Labels</h3>\n<p>\nRig operational state stored as labels on the rig identity bead:\n</p>\n<p>\n<pre><code class=\"language-bash\">bd label add gt-rig-gastown status:docked\nbd label remove gt-rig-gastown status:docked</code></pre>\n</p>\n<h3>Daemon Integration</h3>\n<p>\nThe daemon's lifecycle manager checks config before starting services:\n</p>\n<p>\n<pre><code class=\"language-go\">func (d *Daemon) maybeStartRigServices(rig string) {\n    r := d.getRig(rig)\n\n    status := r.GetConfig(&quot;status&quot;)\n    if status == &quot;parked&quot; || status == &quot;docked&quot; {\n        log.Info(&quot;Rig %s is offline, skipping auto-start&quot;, rig)\n        return\n    }\n\n    d.ensureWitness(rig)\n    d.ensureRefinery(rig)\n}</code></pre>\n</p>\n<h2>Related Documents</h2>\n<ul><li><code>~/gt/docs/hop/PROPERTY-LAYERS.md</code> - Strategic architecture</li>\n<li><code>wisp-architecture.md</code> - Wisp system design</li>\n<li><code>agent-as-bead.md</code> - Agent identity beads (similar pattern)</li></ul>";
---

<DocsLayout title="Property Layers: Multi-Level Configuration" description="> Implementation guide for Gas Town's configuration system. > Created: 2025-01-06">
  <div class="markdown-content" set:html={content} />
</DocsLayout>
