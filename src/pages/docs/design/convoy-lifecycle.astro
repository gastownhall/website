---
import DocsLayout from '../../../layouts/DocsLayout.astro';

const content = "<p>\n> Making convoys actively converge on completion.\n</p>\n<h2>Problem Statement</h2>\n<p>\nConvoys are passive trackers. They group work but don't drive it. The completion\nloop has a structural gap:\n</p>\n<p>\n<pre><code class=\"language-text\">Create → Assign → Execute → Issues close → ??? → Convoy closes</code></pre>\n</p>\n<p>\nThe <code>???</code> is \"Deacon patrol runs <code>gt convoy check</code>\" - a poll-based single point of\nfailure. When Deacon is down, convoys don't close. Work completes but the loop\nnever lands.\n</p>\n<h2>Current State</h2>\n<h3>What Works</h3>\n<ul><li>Convoy creation and issue tracking</li>\n<li><code>gt convoy status</code> shows progress</li>\n<li><code>gt convoy stranded</code> finds unassigned work</li>\n<li><code>gt convoy check</code> auto-closes completed convoys</li>\n</ul>\n<h3>What Breaks</h3>\n<ol><li><strong>Poll-based completion</strong>: Only Deacon runs <code>gt convoy check</code></li>\n<li><strong>No event-driven trigger</strong>: Issue close doesn't propagate to convoy</li>\n<li><strong>No manual close</strong>: Can't force-close abandoned convoys</li>\n<li><strong>Single observer</strong>: No redundant completion detection</li>\n<li><strong>Weak notification</strong>: Convoy owner not always clear</li>\n</ol>\n<h2>Design: Active Convoy Convergence</h2>\n<h3>Principle: Event-Driven, Redundantly Observed</h3>\n<p>\nConvoy completion should be:\n</p>\n<ol><li><strong>Event-driven</strong>: Triggered by issue close, not polling</li>\n<li><strong>Redundantly observed</strong>: Multiple agents can detect and close</li>\n<li><strong>Manually overridable</strong>: Humans can force-close</li>\n</ol>\n<h3>Event-Driven Completion</h3>\n<p>\nWhen an issue closes, check if it's tracked by a convoy:\n</p>\n<p>\n<pre><code class=\"language-text\">Issue closes\n    ↓\nIs issue tracked by convoy? ──(no)──► done\n    │\n   (yes)\n    ↓\nRun gt convoy check &lt;convoy-id&gt;\n    ↓\nAll tracked issues closed? ──(no)──► done\n    │\n   (yes)\n    ↓\nClose convoy, send notifications</code></pre>\n</p>\n<strong>Implementation options:</strong>\n<ol><li>Daemon hook on <code>bd update --status=closed</code></li>\n<li>Refinery step after successful merge</li>\n<li>Witness step after verifying polecat completion</li>\n</ol>\n<p>\nOption 1 is most reliable - catches all closes regardless of source.\n</p>\n<h3>Redundant Observers</h3>\n<p>\nPer PRIMING.md: \"Redundant Monitoring Is Resilience.\"\n</p>\n<p>\nThree places should check convoy completion:\n</p>\n<table><tr><td>Observer</td><td>When</td><td>Scope</td></tr>\n</table>\n<table><tr><td><strong>Daemon</strong></td><td>On any issue close</td><td>All convoys</td></tr>\n<tr><td><strong>Witness</strong></td><td>After verifying polecat work</td><td>Rig's convoy work</td></tr>\n<tr><td><strong>Deacon</strong></td><td>Periodic patrol</td><td>All convoys (backup)</td></tr>\n</table>\n<p>\nAny observer noticing completion triggers close. Idempotent - closing\nan already-closed convoy is a no-op.\n</p>\n<h3>Manual Close Command</h3>\n<strong>Desire path</strong>: <code>gt convoy close</code> is expected but missing.\n<p>\n<pre><code class=\"language-bash\"># Close a completed convoy\ngt convoy close hq-cv-abc\n\n# Force-close an abandoned convoy\ngt convoy close hq-cv-xyz --reason=&quot;work done differently&quot;\n\n# Close with explicit notification\ngt convoy close hq-cv-abc --notify mayor/</code></pre>\n</p>\n<p>\nUse cases:\n</p>\n<ul><li>Abandoned convoys no longer relevant</li>\n<li>Work completed outside tracked path</li>\n<li>Force-closing stuck convoys</li>\n</ul>\n<h3>Convoy Owner/Requester</h3>\n<p>\nTrack who requested the convoy for targeted notifications:\n</p>\n<p>\n<pre><code class=\"language-bash\">gt convoy create &quot;Feature X&quot; gt-abc --owner mayor/ --notify overseer</code></pre>\n</p>\n<table><tr><td>Field</td><td>Purpose</td></tr>\n</table>\n<table><tr><td><code>owner</code></td><td>Who requested (gets completion notification)</td></tr>\n<tr><td><code>notify</code></td><td>Additional subscribers</td></tr>\n</table>\n<p>\nIf <code>owner</code> not specified, defaults to creator (from <code>created_by</code>).\n</p>\n<h3>Convoy States</h3>\n<p>\n<pre><code class=\"language-text\">OPEN ──(all issues close)──► CLOSED\n  │                             │\n  │                             ▼\n  │                    (add issues)\n  │                             │\n  └─────────────────────────────┘\n         (auto-reopens)</code></pre>\n</p>\n<p>\nAdding issues to closed convoy reopens automatically.\n</p>\n<strong>New state for abandonment:</strong>\n<p>\n<pre><code class=\"language-text\">OPEN ──► CLOSED (completed)\n  │\n  └────► ABANDONED (force-closed without completion)</code></pre>\n</p>\n<h3>Timeout/SLA (Future)</h3>\n<p>\nOptional <code>due_at</code> field for convoy deadline:\n</p>\n<p>\n<pre><code class=\"language-bash\">gt convoy create &quot;Sprint work&quot; gt-abc --due=&quot;2026-01-15&quot;</code></pre>\n</p>\n<p>\nOverdue convoys surface in <code>gt convoy stranded --overdue</code>.\n</p>\n<h2>Commands</h2>\n<h3>New: <code>gt convoy close</code></h3>\n<p>\n<pre><code class=\"language-bash\">gt convoy close &lt;convoy-id&gt; [--reason=&lt;reason&gt;] [--notify=&lt;agent&gt;]</code></pre>\n</p>\n<ul><li>Closes convoy regardless of tracked issue status</li>\n<li>Sets <code>close_reason</code> field</li>\n<li>Sends notification to owner and subscribers</li>\n<li>Idempotent - closing closed convoy is no-op</li>\n</ul>\n<h3>Enhanced: <code>gt convoy check</code></h3>\n<p>\n<pre><code class=\"language-bash\"># Check all convoys (current behavior)\ngt convoy check\n\n# Check specific convoy (new)\ngt convoy check &lt;convoy-id&gt;\n\n# Dry-run mode\ngt convoy check --dry-run</code></pre>\n</p>\n<h3>New: <code>gt convoy reopen</code></h3>\n<p>\n<pre><code class=\"language-bash\">gt convoy reopen &lt;convoy-id&gt;</code></pre>\n</p>\n<p>\nExplicit reopen for clarity (currently implicit via add).\n</p>\n<h2>Implementation Priority</h2>\n<ol><li><strong>P0: <code>gt convoy close</code></strong> - Desire path, escape hatch</li>\n<li><strong>P0: Event-driven check</strong> - Daemon hook on issue close</li>\n<li><strong>P1: Redundant observers</strong> - Witness/Refinery integration</li>\n<li><strong>P2: Owner field</strong> - Targeted notifications</li>\n<li><strong>P3: Timeout/SLA</strong> - Deadline tracking</li>\n</ol>\n<h2>Related</h2>\n<ul><li><a href=\"/concepts/convoy\">Convoy</a> - Convoy concept and usage</li>\n<li><a href=\"/design/watchdog-chain\">Watchdog Chain</a> - Deacon patrol system</li>\n<li><a href=\"/design/mail-protocol\">Mail Protocol</a> - Notification delivery</li></ul>";
---

<DocsLayout title="Convoy Lifecycle Design" description="> Making convoys actively converge on completion.">
  <div class="markdown-content" set:html={content} />
</DocsLayout>
