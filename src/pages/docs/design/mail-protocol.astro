---
import DocsLayout from '../../../layouts/DocsLayout.astro';

const content = "<p>\n> Reference for inter-agent mail communication in Gas Town\n</p>\n<h2>Overview</h2>\n<p>\nGas Town agents coordinate via mail messages routed through the beads system.\nMail uses <code>type=message</code> beads with routing handled by <code>gt mail</code>.\n</p>\n<h2>Message Types</h2>\n<h3>POLECAT_DONE</h3>\n<strong>Route</strong>: Polecat â†’ Witness\n<strong>Purpose</strong>: Signal work completion, trigger cleanup flow.\n<strong>Subject format</strong>: <code>POLECAT_DONE &lt;polecat-name&gt;</code>\n<strong>Body format</strong>:\n<p>\n<pre><code class=\"language-text\">Exit: MERGED|ESCALATED|DEFERRED\nIssue: &lt;issue-id&gt;\nMR: &lt;mr-id&gt;          # if exit=MERGED\nBranch: &lt;branch&gt;</code></pre>\n</p>\n<strong>Trigger</strong>: <code>gt done</code> command generates this automatically.\n<strong>Handler</strong>: Witness creates a cleanup wisp for the polecat.\n<h3>MERGE_READY</h3>\n<strong>Route</strong>: Witness â†’ Refinery\n<strong>Purpose</strong>: Signal a branch is ready for merge queue processing.\n<strong>Subject format</strong>: <code>MERGE_READY &lt;polecat-name&gt;</code>\n<strong>Body format</strong>:\n<p>\n<pre><code class=\"language-text\">Branch: &lt;branch&gt;\nIssue: &lt;issue-id&gt;\nPolecat: &lt;polecat-name&gt;\nVerified: clean git state, issue closed</code></pre>\n</p>\n<strong>Trigger</strong>: Witness sends after verifying polecat work is complete.\n<strong>Handler</strong>: Refinery adds to merge queue, processes when ready.\n<h3>MERGED</h3>\n<strong>Route</strong>: Refinery â†’ Witness\n<strong>Purpose</strong>: Confirm branch was merged successfully, safe to nuke polecat.\n<strong>Subject format</strong>: <code>MERGED &lt;polecat-name&gt;</code>\n<strong>Body format</strong>:\n<p>\n<pre><code class=\"language-text\">Branch: &lt;branch&gt;\nIssue: &lt;issue-id&gt;\nPolecat: &lt;polecat-name&gt;\nRig: &lt;rig&gt;\nTarget: &lt;target-branch&gt;\nMerged-At: &lt;timestamp&gt;\nMerge-Commit: &lt;sha&gt;</code></pre>\n</p>\n<strong>Trigger</strong>: Refinery sends after successful merge to main.\n<strong>Handler</strong>: Witness completes cleanup wisp, nukes polecat worktree.\n<h3>MERGE_FAILED</h3>\n<strong>Route</strong>: Refinery â†’ Witness\n<strong>Purpose</strong>: Notify that merge attempt failed (tests, build, or other non-conflict error).\n<strong>Subject format</strong>: <code>MERGE_FAILED &lt;polecat-name&gt;</code>\n<strong>Body format</strong>:\n<p>\n<pre><code class=\"language-text\">Branch: &lt;branch&gt;\nIssue: &lt;issue-id&gt;\nPolecat: &lt;polecat-name&gt;\nRig: &lt;rig&gt;\nTarget: &lt;target-branch&gt;\nFailed-At: &lt;timestamp&gt;\nFailure-Type: &lt;tests|build|push|other&gt;\nError: &lt;error-message&gt;</code></pre>\n</p>\n<strong>Trigger</strong>: Refinery sends when merge fails for non-conflict reasons.\n<strong>Handler</strong>: Witness notifies polecat, assigns work back for rework.\n<h3>REWORK_REQUEST</h3>\n<strong>Route</strong>: Refinery â†’ Witness\n<strong>Purpose</strong>: Request polecat to rebase branch due to merge conflicts.\n<strong>Subject format</strong>: <code>REWORK_REQUEST &lt;polecat-name&gt;</code>\n<strong>Body format</strong>:\n<p>\n<pre><code class=\"language-text\">Branch: &lt;branch&gt;\nIssue: &lt;issue-id&gt;\nPolecat: &lt;polecat-name&gt;\nRig: &lt;rig&gt;\nTarget: &lt;target-branch&gt;\nRequested-At: &lt;timestamp&gt;\nConflict-Files: &lt;file1&gt;, &lt;file2&gt;, ...\n\nPlease rebase your changes onto &lt;target-branch&gt;:\n\n  git fetch origin\n  git rebase origin/&lt;target-branch&gt;\n  # Resolve any conflicts\n  git push -f\n\nThe Refinery will retry the merge after rebase is complete.</code></pre>\n</p>\n<strong>Trigger</strong>: Refinery sends when merge has conflicts with target branch.\n<strong>Handler</strong>: Witness notifies polecat with rebase instructions.\n<h3>WITNESS_PING</h3>\n<strong>Route</strong>: Witness â†’ Deacon (all witnesses send)\n<strong>Purpose</strong>: Second-order monitoring - ensure Deacon is alive.\n<strong>Subject format</strong>: <code>WITNESS_PING &lt;rig&gt;</code>\n<strong>Body format</strong>:\n<p>\n<pre><code class=\"language-text\">Rig: &lt;rig&gt;\nTimestamp: &lt;timestamp&gt;\nPatrol: &lt;cycle-number&gt;</code></pre>\n</p>\n<strong>Trigger</strong>: Each witness sends periodically (every N patrol cycles).\n<strong>Handler</strong>: Deacon acknowledges. If no ack, witnesses escalate to Mayor.\n<h3>HELP</h3>\n<strong>Route</strong>: Any â†’ escalation target (usually Mayor)\n<strong>Purpose</strong>: Request intervention for stuck/blocked work.\n<strong>Subject format</strong>: <code>HELP: &lt;brief-description&gt;</code>\n<strong>Body format</strong>:\n<p>\n<pre><code class=\"language-text\">Agent: &lt;agent-id&gt;\nIssue: &lt;issue-id&gt;       # if applicable\nProblem: &lt;description&gt;\nTried: &lt;what was attempted&gt;</code></pre>\n</p>\n<strong>Trigger</strong>: Agent unable to proceed, needs external help.\n<strong>Handler</strong>: Escalation target assesses and intervenes.\n<h3>HANDOFF</h3>\n<strong>Route</strong>: Agent â†’ self (or successor)\n<strong>Purpose</strong>: Session continuity across context limits/restarts.\n<strong>Subject format</strong>: <code>ğŸ¤ HANDOFF: &lt;brief-context&gt;</code>\n<strong>Body format</strong>:\n<p>\n<pre><code class=\"language-text\">attached_molecule: &lt;molecule-id&gt;   # if work in progress\nattached_at: &lt;timestamp&gt;\n\n## Context\n&lt;freeform notes for successor&gt;\n\n## Status\n&lt;where things stand&gt;\n\n## Next\n&lt;what successor should do&gt;</code></pre>\n</p>\n<strong>Trigger</strong>: <code>gt handoff</code> command, or manual send before session end.\n<strong>Handler</strong>: Next session reads handoff, continues from context.\n<h2>Format Conventions</h2>\n<h3>Subject Line</h3>\n<ul><li><strong>Type prefix</strong>: Uppercase, identifies message type</li>\n<li><strong>Colon separator</strong>: After type for structured info</li>\n<li><strong>Brief context</strong>: Human-readable summary</li>\n</ul>\n<p>\nExamples:\n<pre><code class=\"language-text\">POLECAT_DONE nux\nMERGE_READY greenplace/nux\nHELP: Polecat stuck on test failures\nğŸ¤ HANDOFF: Schema work in progress</code></pre>\n</p>\n<h3>Body Structure</h3>\n<ul><li><strong>Key-value pairs</strong>: For structured data (one per line)</li>\n<li><strong>Blank line</strong>: Separates structured data from freeform content</li>\n<li><strong>Markdown sections</strong>: For freeform content (##, lists, code blocks)</li>\n</ul>\n<h3>Addresses</h3>\n<p>\nFormat: <code>&lt;rig&gt;/&lt;role&gt;</code> or <code>&lt;rig&gt;/&lt;type&gt;/&lt;name&gt;</code>\n</p>\n<p>\nExamples:\n<pre><code class=\"language-text\">greenplace/witness       # Witness for greenplace rig\nbeads/refinery           # Refinery for beads rig\ngreenplace/polecats/nux  # Specific polecat\nmayor/                # Town-level Mayor\ndeacon/               # Town-level Deacon</code></pre>\n</p>\n<h2>Protocol Flows</h2>\n<h3>Polecat Completion Flow</h3>\n<p>\n<pre><code class=\"language-text\">Polecat                    Witness                    Refinery\n   â”‚                          â”‚                          â”‚\n   â”‚ POLECAT_DONE             â”‚                          â”‚\n   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt;â”‚                          â”‚\n   â”‚                          â”‚                          â”‚\n   â”‚                    (verify clean)                   â”‚\n   â”‚                          â”‚                          â”‚\n   â”‚                          â”‚ MERGE_READY              â”‚\n   â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt;â”‚\n   â”‚                          â”‚                          â”‚\n   â”‚                          â”‚                    (merge attempt)\n   â”‚                          â”‚                          â”‚\n   â”‚                          â”‚ MERGED (success)         â”‚\n   â”‚                          â”‚&lt;â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚\n   â”‚                          â”‚                          â”‚\n   â”‚                    (nuke polecat)                   â”‚\n   â”‚                          â”‚                          â”‚</code></pre>\n</p>\n<h3>Merge Failure Flow</h3>\n<p>\n<pre><code class=\"language-text\">Witness                    Refinery\n                              â”‚                          â”‚\n                              â”‚                    (merge fails)\n                              â”‚                          â”‚\n                              â”‚ MERGE_FAILED             â”‚\n   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚&lt;â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚\n   â”‚                          â”‚                          â”‚\n   â”‚ (failure notification)   â”‚                          â”‚\n   â”‚&lt;â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚\n   â”‚                          â”‚                          â”‚\nPolecat (rework needed)</code></pre>\n</p>\n<h3>Rebase Required Flow</h3>\n<p>\n<pre><code class=\"language-text\">Witness                    Refinery\n                              â”‚                          â”‚\n                              â”‚                    (conflict detected)\n                              â”‚                          â”‚\n                              â”‚ REWORK_REQUEST           â”‚\n   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚&lt;â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚\n   â”‚                          â”‚                          â”‚\n   â”‚ (rebase instructions)    â”‚                          â”‚\n   â”‚&lt;â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚\n   â”‚                          â”‚                          â”‚\nPolecat                       â”‚                          â”‚\n   â”‚                          â”‚                          â”‚\n   â”‚ (rebases, gt done)       â”‚                          â”‚\n   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt;â”‚ MERGE_READY              â”‚\n   â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt;â”‚\n   â”‚                          â”‚                    (retry merge)</code></pre>\n</p>\n<h3>Second-Order Monitoring</h3>\n<p>\n<pre><code class=\"language-text\">Witness-1 â”€â”€â”\n            â”‚ WITNESS_PING\nWitness-2 â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt; Deacon\n            â”‚\nWitness-N â”€â”€â”˜\n                                 â”‚\n                          (if no response)\n                                 â”‚\n            &lt;â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n            Escalate to Mayor</code></pre>\n</p>\n<h2>Implementation</h2>\n<h3>Sending Mail</h3>\n<p>\n<pre><code class=\"language-bash\"># Basic send\ngt mail send &lt;addr&gt; -s &quot;Subject&quot; -m &quot;Body&quot;\n\n# With structured body\ngt mail send greenplace/witness -s &quot;MERGE_READY nux&quot; -m &quot;Branch: feature-xyz\nIssue: gp-abc\nPolecat: nux\nVerified: clean&quot;</code></pre>\n</p>\n<h3>Receiving Mail</h3>\n<p>\n<pre><code class=\"language-bash\"># Check inbox\ngt mail inbox\n\n# Read specific message\ngt mail read &lt;msg-id&gt;\n\n# Mark as read\ngt mail ack &lt;msg-id&gt;</code></pre>\n</p>\n<h3>In Patrol Formulas</h3>\n<p>\nFormulas should:\n1. Check inbox at start of each cycle\n2. Parse subject prefix to route handling\n3. Extract structured data from body\n4. Take appropriate action\n5. Mark mail as read after processing\n</p>\n<h2>Extensibility</h2>\n<p>\nNew message types follow the pattern:\n1. Define subject prefix (TYPE: or TYPE_SUBTYPE)\n2. Document body format (key-value pairs + freeform)\n3. Specify route (sender â†’ receiver)\n4. Implement handlers in relevant patrol formulas\n</p>\n<p>\nThe protocol is intentionally simple - structured enough for parsing,\nflexible enough for human debugging.\n</p>\n<h2>Related Documents</h2>\n<ul><li><code>docs/agent-as-bead.md</code> - Agent identity and slots</li>\n<li><code>.beads/formulas/mol-witness-patrol.formula.toml</code> - Witness handling</li>\n<li><code>internal/mail/</code> - Mail routing implementation</li>\n<li><code>internal/protocol/</code> - Protocol handlers for Witness-Refinery communication</li></ul>";
---

<DocsLayout title="Gas Town Mail Protocol" description="> Reference for inter-agent mail communication in Gas Town">
  <div class="markdown-content" set:html={content} />
</DocsLayout>
