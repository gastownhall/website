---
import DocsLayout from '../../layouts/DocsLayout.astro';

const content = "<p>\n> Where formulas live, how they're found, and how they'll scale to Mol Mall\n</p>\n<h2>The Problem</h2>\n<p>\nFormulas currently exist in multiple locations with no clear precedence:\n</p>\n<ul><li><code>.beads/formulas/</code> (source of truth for a project)</li>\n<li><code>internal/formula/formulas/</code> (embedded copy for <code>go install</code>)</li>\n<li>Crew directories have their own <code>.beads/formulas/</code> (diverging copies)</li>\n</ul>\n<p>\nWhen an agent runs <code>bd cook mol-polecat-work</code>, which version do they get?\n</p>\n<h2>Design Goals</h2>\n<p>\n1. <strong>Predictable resolution</strong> - Clear precedence rules\n2. <strong>Local customization</strong> - Override system defaults without forking\n3. <strong>Project-specific formulas</strong> - Committed workflows for collaborators\n4. <strong>Mol Mall ready</strong> - Architecture supports remote formula installation\n5. <strong>Federation ready</strong> - Formulas are shareable across towns via HOP (Highway Operations Protocol)\n</p>\n<h2>Three-Tier Resolution</h2>\n<p>\n<pre><code class=\"language-text\">┌─────────────────────────────────────────────────────────────────┐\n│                     FORMULA RESOLUTION ORDER                     │\n│                    (most specific wins)                          │\n└─────────────────────────────────────────────────────────────────┘\n\nTIER 1: PROJECT (rig-level)\n  Location: &lt;project&gt;/.beads/formulas/\n  Source:   Committed to project repo\n  Use case: Project-specific workflows (deploy, test, release)\n  Example:  ~/gt/gastown/.beads/formulas/mol-gastown-release.formula.toml\n\nTIER 2: TOWN (user-level)\n  Location: ~/gt/.beads/formulas/\n  Source:   Mol Mall installs, user customizations\n  Use case: Cross-project workflows, personal preferences\n  Example:  ~/gt/.beads/formulas/mol-polecat-work.formula.toml (customized)\n\nTIER 3: SYSTEM (embedded)\n  Location: Compiled into gt binary\n  Source:   gastown/mayor/rig/.beads/formulas/ at build time\n  Use case: Defaults, blessed patterns, fallback\n  Example:  mol-polecat-work.formula.toml (factory default)</code></pre>\n</p>\n<h3>Resolution Algorithm</h3>\n<p>\n<pre><code class=\"language-go\">func ResolveFormula(name string, cwd string) (Formula, Tier, error) {\n    // Tier 1: Project-level (walk up from cwd to find .beads/formulas/)\n    if projectDir := findProjectRoot(cwd); projectDir != &quot;&quot; {\n        path := filepath.Join(projectDir, &quot;.beads&quot;, &quot;formulas&quot;, name+&quot;.formula.toml&quot;)\n        if f, err := loadFormula(path); err == nil {\n            return f, TierProject, nil\n        }\n    }\n\n    // Tier 2: Town-level\n    townDir := getTownRoot() // ~/gt or $GT_HOME\n    path := filepath.Join(townDir, &quot;.beads&quot;, &quot;formulas&quot;, name+&quot;.formula.toml&quot;)\n    if f, err := loadFormula(path); err == nil {\n        return f, TierTown, nil\n    }\n\n    // Tier 3: Embedded (system)\n    if f, err := loadEmbeddedFormula(name); err == nil {\n        return f, TierSystem, nil\n    }\n\n    return nil, 0, ErrFormulaNotFound\n}</code></pre>\n</p>\n<h3>Why This Order</h3>\n<strong>Project wins</strong> because:\n<ul><li>Project maintainers know their workflows best</li>\n<li>Collaborators get consistent behavior via git</li>\n<li>CI/CD uses the same formulas as developers</li>\n</ul>\n<strong>Town is middle</strong> because:\n<ul><li>User customizations override system defaults</li>\n<li>Mol Mall installs don't require project changes</li>\n<li>Cross-project consistency for the user</li>\n</ul>\n<strong>System is fallback</strong> because:\n<ul><li>Always available (compiled in)</li>\n<li>Factory reset target</li>\n<li>The \"blessed\" versions</li>\n</ul>\n<h2>Formula Identity</h2>\n<h3>Current Format</h3>\n<p>\n<pre><code class=\"language-toml\">formula = &quot;mol-polecat-work&quot;\nversion = 4\ndescription = &quot;...&quot;</code></pre>\n</p>\n<h3>Extended Format (Mol Mall Ready)</h3>\n<p>\n<pre><code class=\"language-toml\">[formula]\nname = &quot;mol-polecat-work&quot;\nversion = &quot;4.0.0&quot;                          # Semver\nauthor = &quot;steve@gastown.io&quot;                # Author identity\nlicense = &quot;MIT&quot;\nrepository = &quot;https://github.com/steveyegge/gastown&quot;\n\n[formula.registry]\nuri = &quot;hop://molmall.gastown.io/formulas/mol-polecat-work@4.0.0&quot;\nchecksum = &quot;sha256:abc123...&quot;              # Integrity verification\nsigned_by = &quot;steve@gastown.io&quot;             # Optional signing\n\n[formula.capabilities]\n# What capabilities does this formula exercise? Used for agent routing.\nprimary = [&quot;go&quot;, &quot;testing&quot;, &quot;code-review&quot;]\nsecondary = [&quot;git&quot;, &quot;ci-cd&quot;]</code></pre>\n</p>\n<h3>Version Resolution</h3>\n<p>\nWhen multiple versions exist:\n</p>\n<p>\n<pre><code class=\"language-bash\">bd cook mol-polecat-work          # Resolves per tier order\nbd cook mol-polecat-work@4        # Specific major version\nbd cook mol-polecat-work@4.0.0    # Exact version\nbd cook mol-polecat-work@latest   # Explicit latest</code></pre>\n</p>\n<h2>Crew Directory Problem</h2>\n<h3>Current State</h3>\n<p>\nCrew directories (<code>gastown/crew/max/</code>) are sparse checkouts of gastown. They have:\n</p>\n<ul><li>Their own <code>.beads/formulas/</code> (from the checkout)</li>\n<li>These can diverge from <code>mayor/rig/.beads/formulas/</code></li>\n</ul>\n<h3>The Fix</h3>\n<p>\nCrew should NOT have their own formula copies. Options:\n</p>\n<strong>Option A: Symlink/Redirect</strong>\n<p>\n<pre><code class=\"language-bash\"># crew/max/.beads/formulas -&gt; ../../mayor/rig/.beads/formulas</code></pre>\nAll crew share the rig's formulas.\n</p>\n<strong>Option B: Provision on Demand</strong>\n<p>\nCrew directories don't have <code>.beads/formulas/</code>. Resolution falls through to:\n1. Town-level (~/gt/.beads/formulas/)\n2. System (embedded)\n</p>\n<strong>Option C: Sparse Checkout Exclusion</strong>\n<p>\nExclude <code>.beads/formulas/</code> from crew sparse checkouts entirely.\n</p>\n<strong>Recommendation: Option B</strong> - Crew shouldn't need project-level formulas. They work on the project, they don't define its workflows.\n<h2>Commands</h2>\n<h3>Existing</h3>\n<p>\n<pre><code class=\"language-bash\">bd formula list              # Available formulas (should show tier)\nbd formula show &lt;name&gt;       # Formula details\nbd cook &lt;formula&gt;            # Formula → Proto</code></pre>\n</p>\n<h3>Enhanced</h3>\n<p>\n<pre><code class=\"language-bash\"># List with tier information\nbd formula list\n  mol-polecat-work          v4    [project]\n  mol-polecat-code-review   v1    [town]\n  mol-witness-patrol        v2    [system]\n\n# Show resolution path\nbd formula show mol-polecat-work --resolve\n  Resolving: mol-polecat-work\n  ✓ Found at: ~/gt/gastown/.beads/formulas/mol-polecat-work.formula.toml\n  Tier: project\n  Version: 4\n\n  Resolution path checked:\n  1. [project] ~/gt/gastown/.beads/formulas/ ← FOUND\n  2. [town]    ~/gt/.beads/formulas/\n  3. [system]  &lt;embedded&gt;\n\n# Override tier for testing\nbd cook mol-polecat-work --tier=system    # Force embedded version\nbd cook mol-polecat-work --tier=town      # Force town version</code></pre>\n</p>\n<h3>Future (Mol Mall)</h3>\n<p>\n<pre><code class=\"language-bash\"># Install from Mol Mall\ngt formula install mol-code-review-strict\ngt formula install mol-code-review-strict@2.0.0\ngt formula install hop://acme.corp/formulas/mol-deploy\n\n# Manage installed formulas\ngt formula list --installed              # What's in town-level\ngt formula upgrade mol-polecat-work      # Update to latest\ngt formula pin mol-polecat-work@4.0.0    # Lock version\ngt formula uninstall mol-code-review-strict</code></pre>\n</p>\n<h2>Migration Path</h2>\n<h3>Phase 1: Resolution Order (Now)</h3>\n<p>\n1. Implement three-tier resolution in <code>bd cook</code>\n2. Add <code>--resolve</code> flag to show resolution path\n3. Update <code>bd formula list</code> to show tiers\n4. Fix crew directories (Option B)\n</p>\n<h3>Phase 2: Town-Level Formulas</h3>\n<p>\n1. Establish <code>~/gt/.beads/formulas/</code> as town formula location\n2. Add <code>gt formula</code> commands for managing town formulas\n3. Support manual installation (copy file, track in <code>.installed.json</code>)\n</p>\n<h3>Phase 3: Mol Mall Integration</h3>\n<p>\n1. Define registry API (see mol-mall-design.md)\n2. Implement <code>gt formula install</code> from remote\n3. Add version pinning and upgrade flows\n4. Add integrity verification (checksums, optional signing)\n</p>\n<h3>Phase 4: Federation (HOP)</h3>\n<p>\n1. Add capability tags to formula schema\n2. Track formula execution for agent accountability\n3. Enable federation (cross-town formula sharing via Highway Operations Protocol)\n4. Author attribution and validation records\n</p>\n<h2>Related Documents</h2>\n<ul><li><a href=\"mol-mall-design.md\">Mol Mall Design</a> - Registry architecture</li>\n<li><a href=\"molecules.md\">molecules.md</a> - Formula → Proto → Mol lifecycle</li>\n<li><a href=\"../../../docs/understanding-gas-town.md\">understanding-gas-town.md</a> - Gas Town architecture</li></ul>";
---

<DocsLayout title="Formula Resolution Architecture" description="> Where formulas live, how they're found, and how they'll scale to Mol Mall">
  <div class="markdown-content" set:html={content} />
</DocsLayout>
