---
import DocsLayout from '../../layouts/DocsLayout.astro';

const content = "<p>\nThis document describes the beads-native messaging system for Gas Town, which replaces the file-based messaging configuration with persistent beads stored in the town's <code>.beads</code> directory.\n</p>\n<h2>Overview</h2>\n<p>\nBeads-native messaging introduces three new bead types for managing communication:\n</p>\n<ul><li><strong>Groups</strong> (<code>gt:group</code>) - Named collections of addresses for mail distribution</li>\n<li><strong>Queues</strong> (<code>gt:queue</code>) - Work queues where messages can be claimed by workers</li>\n<li><strong>Channels</strong> (<code>gt:channel</code>) - Pub/sub broadcast streams with message retention</li>\n</ul>\n<p>\nAll messaging beads use the <code>hq-</code> prefix because they are town-level entities that span rigs.\n</p>\n<h2>Bead Types</h2>\n<h3>Groups (<code>gt:group</code>)</h3>\n<p>\nGroups are named collections of addresses used for mail distribution. When you send to a group, the message is delivered to all members.\n</p>\n<strong>Bead ID format:</strong> <code>hq-group-<name></code> (e.g., <code>hq-group-ops-team</code>)\n<strong>Fields:</strong>\n<ul><li><code>name</code> - Unique group name</li>\n<li><code>members</code> - Comma-separated list of addresses, patterns, or nested group names</li>\n<li><code>created_by</code> - Who created the group (from BD_ACTOR)</li>\n<li><code>created_at</code> - ISO 8601 timestamp</li>\n</ul>\n<strong>Member types:</strong>\n<ul><li>Direct addresses: <code>gastown/crew/max</code>, <code>mayor/</code>, <code>deacon/</code></li>\n<li>Wildcard patterns: <code><em>/witness</code>, <code>gastown/</em></code>, <code>gastown/crew/<em></code></li>\n<li>Special patterns: <code>@town</code>, <code>@crew</code>, <code>@witnesses</code></li>\n<li>Nested groups: Reference other group names</li>\n</ul>\n<h3>Queues (<code>gt:queue</code>)</h3>\n<p>\nQueues are work queues where messages wait to be claimed by workers. Unlike groups, each message goes to exactly one claimant.\n</p>\n<strong>Bead ID format:</strong> <code>hq-q-<name></code> (town-level) or <code>gt-q-<name></code> (rig-level)\n<strong>Fields:</strong>\n<ul><li><code>name</code> - Queue name</li>\n<li><code>status</code> - <code>active</code>, <code>paused</code>, or <code>closed</code></li>\n<li><code>max_concurrency</code> - Maximum concurrent workers (0 = unlimited)</li>\n<li><code>processing_order</code> - <code>fifo</code> or <code>priority</code></li>\n<li><code>available_count</code> - Items ready to process</li>\n<li><code>processing_count</code> - Items currently being processed</li>\n<li><code>completed_count</code> - Items completed</li>\n<li><code>failed_count</code> - Items that failed</li>\n</ul>\n<h3>Channels (<code>gt:channel</code>)</h3>\n<p>\nChannels are pub/sub streams for broadcasting messages. Messages are retained according to the channel's retention policy.\n</p>\n<strong>Bead ID format:</strong> <code>hq-channel-<name></code> (e.g., <code>hq-channel-alerts</code>)\n<strong>Fields:</strong>\n<ul><li><code>name</code> - Unique channel name</li>\n<li><code>subscribers</code> - Comma-separated list of subscribed addresses</li>\n<li><code>status</code> - <code>active</code> or <code>closed</code></li>\n<li><code>retention_count</code> - Number of recent messages to retain (0 = unlimited)</li>\n<li><code>retention_hours</code> - Hours to retain messages (0 = forever)</li>\n<li><code>created_by</code> - Who created the channel</li>\n<li><code>created_at</code> - ISO 8601 timestamp</li>\n</ul>\n<h2>CLI Commands</h2>\n<h3>Group Management</h3>\n<pre><code class=\"language-bash\"># List all groups\n<p>\ngt mail group list\n</p>\n<h1>Show group details</h1>\n<p>\ngt mail group show &lt;name&gt;\n</p>\n<h1>Create a new group with members</h1>\n<p>\ngt mail group create &lt;name&gt; [members...]\ngt mail group create ops-team gastown/witness gastown/crew/max\n</p>\n<h1>Add member to group</h1>\n<p>\ngt mail group add &lt;name&gt; &lt;member&gt;\n</p>\n<h1>Remove member from group</h1>\n<p>\ngt mail group remove &lt;name&gt; &lt;member&gt;\n</p>\n<h1>Delete a group</h1>\n<p>\ngt mail group delete &lt;name&gt;</code></pre>\n</p>\n<h3>Channel Management</h3>\n<pre><code class=\"language-bash\"># List all channels\n<p>\ngt mail channel\ngt mail channel list\n</p>\n<h1>View channel messages</h1>\n<p>\ngt mail channel &lt;name&gt;\ngt mail channel show &lt;name&gt;\n</p>\n<h1>Create a channel with retention policy</h1>\n<p>\ngt mail channel create &lt;name&gt; [--retain-count=N] [--retain-hours=N]\ngt mail channel create alerts --retain-count=100\n</p>\n<h1>Delete a channel</h1>\n<p>\ngt mail channel delete &lt;name&gt;</code></pre>\n</p>\n<h3>Sending Messages</h3>\n<p>\nThe <code>gt mail send</code> command now supports groups, queues, and channels:\n</p>\n<pre><code class=\"language-bash\"># Send to a group (expands to all members)\n<p>\ngt mail send my-group -s &quot;Subject&quot; -m &quot;Body&quot;\n</p>\n<h1>Send to a queue (single message, workers claim)</h1>\n<p>\ngt mail send queue:my-queue -s &quot;Work item&quot; -m &quot;Details&quot;\n</p>\n<h1>Send to a channel (broadcast with retention)</h1>\n<p>\ngt mail send channel:my-channel -s &quot;Announcement&quot; -m &quot;Content&quot;\n</p>\n<h1>Direct address (unchanged)</h1>\n<p>\ngt mail send gastown/crew/max -s &quot;Hello&quot; -m &quot;World&quot;</code></pre>\n</p>\n<h2>Address Resolution</h2>\n<p>\nWhen sending mail, addresses are resolved in this order:\n</p>\n<p>\n1. <strong>Explicit prefix</strong> - If address starts with <code>group:</code>, <code>queue:</code>, or <code>channel:</code>, use that type directly\n2. <strong>Contains <code>/</code></strong> - Treat as agent address or pattern (direct delivery)\n3. <strong>Starts with <code>@</code></strong> - Special pattern (<code>@town</code>, <code>@crew</code>, etc.) or beads-native group\n4. <strong>Name lookup</strong> - Search for group → queue → channel by name\n</p>\n<p>\nIf a name matches multiple types (e.g., both a group and a channel named \"alerts\"), the resolver returns an error and requires an explicit prefix.\n</p>\n<h2>Key Implementation Files</h2>\n<table><tr><td>File</td><td>Description</td></tr>\n</table>\n<table><tr><td><code>internal/beads/beads_group.go</code></td><td>Group bead CRUD operations</td></tr>\n<tr><td><code>internal/beads/beads_queue.go</code></td><td>Queue bead CRUD operations</td></tr>\n<tr><td><code>internal/beads/beads_channel.go</code></td><td>Channel bead + retention logic</td></tr>\n<tr><td><code>internal/mail/resolve.go</code></td><td>Address resolution logic</td></tr>\n<tr><td><code>internal/cmd/mail_group.go</code></td><td>Group CLI commands</td></tr>\n<tr><td><code>internal/cmd/mail_channel.go</code></td><td>Channel CLI commands</td></tr>\n<tr><td><code>internal/cmd/mail_send.go</code></td><td>Updated send with resolver</td></tr>\n</table>\n<h2>Retention Policy</h2>\n<p>\nChannels support two retention mechanisms:\n</p>\n<ul><li><strong>Count-based</strong> (<code>--retain-count=N</code>): Keep only the last N messages</li>\n<li><strong>Time-based</strong> (<code>--retain-hours=N</code>): Delete messages older than N hours</li>\n</ul>\n<p>\nRetention is enforced:\n1. <strong>On-write</strong>: After posting a new message, old messages are pruned\n2. <strong>On-patrol</strong>: Deacon patrol runs <code>PruneAllChannels()</code> as a backup cleanup\n</p>\n<p>\nThe patrol uses a 10% buffer to avoid thrashing (only prunes if count > retainCount × 1.1).\n</p>\n<h2>Examples</h2>\n<h3>Create a team distribution group</h3>\n<pre><code class=\"language-bash\"># Create a group for the ops team\n<p>\ngt mail group create ops-team gastown/witness gastown/crew/max deacon/\n</p>\n<h1>Send to the group</h1>\n<p>\ngt mail send ops-team -s &quot;Team meeting&quot; -m &quot;Tomorrow at 10am&quot;\n</p>\n<h1>Add a new member</h1>\n<p>\ngt mail group add ops-team gastown/crew/dennis</code></pre>\n</p>\n<h3>Set up an alerts channel</h3>\n<pre><code class=\"language-bash\"># Create an alerts channel that keeps last 50 messages\n<p>\ngt mail channel create alerts --retain-count=50\n</p>\n<h1>Send an alert</h1>\n<p>\ngt mail send channel:alerts -s &quot;Build failed&quot; -m &quot;See CI for details&quot;\n</p>\n<h1>View recent alerts</h1>\n<p>\ngt mail channel alerts</code></pre>\n</p>\n<h3>Create nested groups</h3>\n<pre><code class=\"language-bash\"># Create role-based groups\n<p>\ngt mail group create witnesses </em>/witness\ngt mail group create leads gastown/crew/max gastown/crew/dennis\n</p>\n<h1>Create a group that includes other groups</h1>\n<p>\ngt mail group create all-hands witnesses leads mayor/</code></pre>\n</p>";
---

<DocsLayout title="Beads-Native Messaging" description="This document describes the beads-native messaging system for Gas Town, which replaces the file-based messaging configuration with persistent beads stored in th">
  <div class="markdown-content" set:html={content} />
</DocsLayout>
